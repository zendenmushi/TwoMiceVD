# ペアリング動作 修正計画 v0.1

本ドキュメントは、ペアリング開始時の前提確認（仮想デスクトップ構成と位置の検証）を追加し、運用を安定させるための修正計画を示します。

## 目的 / ゴール
- ペアリングは「メイン（左端）の仮想デスクトップ」で開始することを強制し、誤った割当や想定外の切替を防止する。
- 仮想デスクトップは「ちょうど2枚」であることを前提とし、それ以外の構成（1枚／3枚以上）を検出して明確に案内する。
- 検証で取得した2枚の仮想デスクトップ GUID を保存し、次回起動時に GUID の妥当性を検証する。

## 前提 / 使用 API
- キー送出: `H.InputSimulator`（Win+Ctrl+←/→）
- 仮想デスクトップ COM: `IVirtualDesktopManager`
  - `GetWindowDesktopId(HWND, out GUID)` 現在のウィンドウが属する仮想デスクトップ GUID を取得
  - `MoveWindowToDesktop(HWND, REFGUID)` 指定 GUID の仮想デスクトップにウィンドウを移動（存在判定に利用）
- 検証用に不可視のトップレベル ウィンドウ（Probe）を都度作成

参考 COM 宣言（C#）:
```csharp
[ComImport]
[Guid("A5CD92FF-29BE-454C-8D04-D82879FB3F1B")]
[InterfaceType(ComInterfaceType.InterfaceIsIUnknown)]
interface IVirtualDesktopManager
{
    int IsWindowOnCurrentVirtualDesktop(IntPtr topLevelWindow, out bool onCurrentDesktop);
    int GetWindowDesktopId(IntPtr topLevelWindow, out Guid desktopId);
    int MoveWindowToDesktop(IntPtr topLevelWindow, ref Guid desktopId);
}

[ComImport]
[Guid("AA509086-5CA9-4C25-8F95-589D3C07B48A")]
class VirtualDesktopManager {}
```

## 振る舞い仕様（ユーザーフロー）
ペアリングメニュー選択時に、下記の検証を実施してからペアリングダイアログを開く。

1) メイン（左端）判定
- 現在のデスクトップ GUID（`baseGuid`）を取得（Probe ウィンドウを作成して `GetWindowDesktopId`）。
- Win+Ctrl+← を送信、200〜350ms 待機。
- 新たに Probe を作成して `leftGuid` を取得。
- 比較:
  - `leftGuid == baseGuid` → すでに左端（メイン）。検証 OK（次の項へ）。
  - `leftGuid != baseGuid` → 左に更にデスクトップが存在＝メイン以外から開始。
    - メッセージ表示: 「ペアリングはメイン（左端）のデスクトップで開始してください。メインへ切り替えてから再度お試しください。」
    - 可能なら Win+Ctrl+→ を1回送出して元の位置に戻す。
    - クローズ。

2) 枚数（右側）判定
- Win+Ctrl+→ を送信、待機。
- Probe を作成して `right1Guid` を取得。
- 比較:
  - `right1Guid == baseGuid` → デスクトップが1枚しか無い。
    - メッセージ表示: 「仮想デスクトップが1枚です。新しいデスクトップを作成してから再度ペアリングしてください。」
    - クローズ。
  - `right1Guid != baseGuid` → 少なくとも2枚存在。
    - 続けて Win+Ctrl+→ を送信、待機。
    - Probe を作成して `right2Guid` を取得。
    - 比較:
      - `right2Guid != right1Guid` かつ `right2Guid != baseGuid` → 3枚以上存在。
        - 可能なら Win+Ctrl+← を2回送出する等でメイン（`baseGuid`）へ戻す。
        - メッセージ表示: 「仮想デスクトップが3枚以上あります。本アプリは2枚までを想定しています。メインへ戻して構成を見直してから再度お試しください。」
        - クローズ。
      - それ以外（`right2Guid == right1Guid`）→ 2枚構成であることを確認。検証 OK。

3) ペアリング続行
- `baseGuid` を「VD0」、`right1Guid` を「VD1」として設定に保存（`VirtualDesktops.Mode = GUID`、`Ids["VD0"] = baseGuid`, `Ids["VD1"] = right1Guid`）。
- 可能であればメイン（`baseGuid`）へ戻す（Win+Ctrl+← など、または GUID を用いた戻し）。
- ペアリングダイアログを表示。

4) 次回起動時の GUID 検証
- 起動直後、不可視の Probe を作成。
- 設定に保存された `VD0`, `VD1` の GUID について `MoveWindowToDesktop(Probe, guid)` を実行。
  - 戻り値 `S_OK` → GUID 有効（存在）。
  - 失敗（非 S_OK）→ GUID が無効（デスクトップ構成が変更された可能性）。
    - 案内: 「保存された仮想デスクトップが見つかりません。必要に応じてペアリングをやり直してください。」
- 検証完了後は Probe を破棄。

## UI メッセージ（案）
- メイン以外から開始: 「ペアリングはメイン（左端）のデスクトップで開始してください。メインへ切り替えてから再度お試しください。」
- 1枚のみ: 「仮想デスクトップが1枚です。新しいデスクトップを作成してから再度ペアリングしてください。」
- 3枚以上: 「仮想デスクトップが3枚以上あります。本アプリは2枚までを想定しています。メインへ戻して構成を見直してから再度お試しください。」
- GUID 不整合（起動時）: 「保存された仮想デスクトップが見つかりません。必要に応じてペアリングをやり直してください。」

文言は最終 UI ポリッシュ時に調整可。

## 実装方針（差分）
- `Interop/VirtualDesktopManager.cs`（新規）
  - `IVirtualDesktopManager` COM 宣言／生成ラッパ。
  - `GetWindowDesktopId(HWND)` / `MoveWindowToDesktop(HWND, Guid)` を提供。
- `Core/VirtualDesktopController.cs`
  - 上記ラッパを注入し、ショートカット送出（既存）に加えて GUID 取得ヘルパーを追加。
  - `CreateProbeWindow()`（不可視トップレベル Window 作成）/ `GetDesktopGuidFromProbe()` を提供。
- `UI/TrayUI.cs`
  - 「ペアリング開始」クリック時に検証フローを実行。
  - 条件 NG の場合はメッセージ表示のうえダイアログを開かず終了（可能であればメインへ戻す）。
- `UI/PairingDialog.cs`
  - 既存フローは変更なし。呼び出し前に前提検証を済ませる。
- `Configuration/ConfigStore.cs`
  - `VirtualDesktops.Mode = GUID` と `Ids["VD0"], Ids["VD1"]` の保存／読み込み。
  - 起動時の GUID 検証ヘルパー（`TryValidateStoredDesktopGuids()`）を追加しても良い。
- `Program.cs`
  - 起動時に GUID 検証（存在チェック）を実行。失敗時の案内とフォールバック（インデックス運用）を検討。

## 疑似コード（検証フロー）
```csharp
Guid baseGuid = GetGuidFromNewProbe();

SendLeft(); Wait();
Guid leftGuid = GetGuidFromNewProbe();
if (leftGuid != baseGuid) {
  Show("メインで開始してください");
  TrySendRight(); // もとへ戻す
  return Cancel;
}

SendRight(); Wait();
Guid right1Guid = GetGuidFromNewProbe();
if (right1Guid == baseGuid) {
  Show("デスクトップを作成してください");
  return Cancel;
}

SendRight(); Wait();
Guid right2Guid = GetGuidFromNewProbe();
if (right2Guid != right1Guid && right2Guid != baseGuid) {
  TryReturnTo(baseGuid);
  Show("デスクトップは二つまで");
  return Cancel;
}

// OK: 2枚構成
SaveGuids(VD0: baseGuid, VD1: right1Guid);
TryReturnTo(baseGuid);
OpenPairingDialog();
```

待機は 200〜350ms の固定待機に加え、最大 1s 程度まで 50ms 間隔で GUID 変化をポーリングする実装を推奨（アニメーションや負荷による遅延吸収）。

## 例外・フォールバック
- COM 取得失敗時: 現行のキーボード送出・インデックス方式にフォールバックし、ガイダンスを表示。
- キー送出の競合: Raw Input による自動切替を一時無効化（ペアリング検証中フラグ）して干渉を防止。
- 失敗パスでは可能な範囲でメイン（`baseGuid`）へ戻す努力を行い、ユーザーを混乱させない。

## テスト観点（受け入れ条件）
- 左端で開始 → 左カーソル送出後も GUID が変化しないことを検出できる。
- 1枚構成 → 右カーソル送出後も GUID が変化しないことを検出し、案内して終了する。
- 2枚構成 → `baseGuid` と `right1Guid` を正しく保存し、ペアリングへ遷移する。
- 3枚以上 → 2回右送りで 3 枚目を検出し、メインに戻して案内する。
- 次回起動 → `MoveWindowToDesktop` により GUID の存在を検出できる（成功／失敗双方）。

## 影響範囲 / 変更規模（目安）
- 追加ファイル: 1〜2（COM ラッパ、必要なら Probe Window）
- 既存更新: `VirtualDesktopController`, `TrayUI`, `ConfigStore`, `Program`
- 工数目安: 0.5〜1.0 日（検証・調整含む）

## 備考
- Windows のバージョン差分や将来互換性に配慮し、COM 失敗時のフォールバックは残す。
- Probe ウィンドウは `ShowInTaskbar = false`, `WS_EX_TOOLWINDOW` 等で不可視とし、検証後は必ず破棄する。

