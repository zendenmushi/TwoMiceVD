# TwoMiceVD 仕様書 v0.1
## 目的

本アプリケーションは、2台の物理マウスを個別に認識し、各マウスに紐づく仮想デスクトップへ自動で切り替える常駐ソフトウェアです。Windows 11 環境において Raw Input API を用いて各マウスの入力を監視し、仮想デスクトップの切り替えには主に非公開の Virtual Desktop COM API（方式A）を用い、失敗時に公開ショートカット経由の SendInput 方式（方式B）へフォールバックします。

## 対象環境

OS: Windows 11 22H2 以降（x64）

特権: 一般ユーザーで実行可能。管理者権限は不要。

入力デバイス: 標準 HID マウス（USB／Bluetooth 等）を2台使用。

言語: 実装言語は C# (.NET 8 以上)。C++ ではなく C# を採用。

仮想デスクトップ: Windows の Virtual Desktop 機能（Win+Ctrl+D／矢印で切り替え）を指す。

## 機能概要

アプリ起動時にタスクトレイへ常駐し、既存の仮想デスクトップが1枚のみの場合は自動で1枚追加して合計2枚とする。

ペアリングモードでそれぞれのマウスを動かして識別し、マウスA・マウスBを設定ファイルに保存する。

通常運用では、マウスAに入力があると仮想デスクトップ#1へ、マウスBに入力があると仮想デスクトップ#2へ切り替える。

入力検知は移動のみをトリガーとし、ボタンやスクロールは無視する。

切替の過敏さを抑えるため、移動量のしきい値（既定5）とヒステリシス（既定400 ms）を用いる。

タスクトレイアイコンのコンテキストメニューからペアリング開始、割当反転、感度設定、クールダウン設定、起動時自動開始などを変更できる。

設定は "%LOCALAPPDATA%\TwoMiceVD\config.json" に JSON 形式で保存し、次回起動時に復元する。

## アーキテクチャ
### モジュール構成

RawInputManager: RegisterRawInputDevices によりマウス入力をバックグラウンドで受信し、WM_INPUT の RAWINPUTHEADER.hDevice を用いて各デバイスを識別する。入力イベントの累積移動量を計算し、しきい値を超えた場合にイベントを発火する。

VirtualDesktopController: 仮想デスクトップの列挙・作成・切替を担う。主に Virtual Desktop COM API を使用し、失敗した場合は SendInput で Win+Ctrl+←/→ を送出するフォールバックロジックを持つ。

SwitchPolicy: RawInputManager からの入力イベントを受け取り、しきい値・ヒステリシス・最大切替回数などのロジックに従って切替を判断する。

TrayUI: Windows.Forms または WPF の NotifyIcon を利用してタスクトレイに常駐し、ユーザーインタラクションを提供する。

ConfigStore: 設定ファイルの読み書きを担当。デバイスの識別子（デバイスパスや VID/PID）、仮想デスクトップの GUID/インデックス、閾値などを保存する。

### 切替方式
方式A: Virtual Desktop COM API

Windows 10/11 の仮想デスクトップ管理用非公開 COM インターフェイス群を介してデスクトップを列挙・作成し、GUID を記憶して直接切替を行う。

非公開 API であるため将来の OS 更新で互換性が失われる可能性がある。COM 呼び出しに失敗した場合は自動的に方式Bへフォールバックする。

実装では IVirtualDesktopManager、IVirtualDesktopManagerInternal 相当のインターフェイスを C# の ComImport で宣言し、必要なメソッドを呼び出す。

方式B: SendInput

SendInput API を用いて Win+Ctrl+→ または Win+Ctrl+← の仮想キーを送出し、必要回数だけデスクトップを移動して目標インデックスへ到達する。

起動時に現在インデックスと総枚数を推定し、ユーザーが手動でデスクトップを切り替えた場合でも再同期する仕組みを備える。

### 切替ロジック

RawInputManager が検知した各マウスの累積移動量が threshold_movement（既定5）を超えるとそのマウスに紐づくデスクトップへ切り替えを要求する。

切替後 hysteresis_ms（既定400 ms）以内は切替を抑止し、最大切替回数 max_switch_per_sec（既定2）で無限ループを防ぐ。

しきい値やヒステリシスはユーザーが設定変更可能であり、数値は ConfigStore に保存される。

### 設定項目 (既定値)

threshold_movement: 5 (連続移動カウント)

hysteresis_ms: 400 (ms)

max_switch_per_sec: 2

use_internal_vd_api: true (方式Aを優先)

vd_count_target: 2 (仮想デスクトップ総数)

startup_run: false (起動時に自動起動しない)

swap_bindings: false (マウス割当反転しない)

### タスクトレイUI

ペアリング開始: マウスA/B の識別を再設定するダイアログを表示する。

割当反転: マウスA/B の割り当てを入れ替える。

感度設定: threshold_movement を1〜20のスライダで変更。

クールダウン設定: hysteresis_ms を200〜1000ms の範囲で変更。

起動時に自動開始: 登録すると HKCU の Run レジストリにエントリを追加する。

ログ: 最近の切替やエラーなどを表示するウィンドウを開く。

終了: アプリケーションを終了する。

### 永続化の例 (config.json)
{
  "devices": {
    "A": {"device_path":"\\\\?\\HID#VID_046D&PID_C52B#...", "vid":1133, "pid":50475},
    "B": {"device_path":"\\\\?\\HID#VID_1532&PID_0084#...", "vid":5426, "pid":132}
  },
  "bindings": {"A":"VD0","B":"VD1"},
  "virtual_desktops": {
    "mode": "GUID",
    "ids": {"VD0":"{GUID0}", "VD1":"{GUID1}"},
    "target_count": 2
  },
  "switch": {"threshold":5,"hysteresis_ms":400,"max_per_sec":2},
  "ui": {"startup_run": false, "swap_bindings": false},
  "impl": {"prefer_internal_api": true}
}

### 受け入れ試験 (抜粋)

2台のマウスをペアリング後に順次動かすと仮想デスクトップ#1と#2に正しく切り替わること。

しきい値未満の微小な移動では切り替えが発生しないこと。

ヒステリシス期間内に連続した入力があっても多重切り替えが起こらないこと。

仮想デスクトップが1枚しかない状態でも起動時に自動で1枚追加されること。

COM API が利用できない環境でも SendInput 方式でデスクトップ切り替えが行われること。

### 保守・拡張のメモ

非公開の COM API は将来の更新により変更される可能性があるため、障害発生時にフォールバックを自動的に利用する仕組みを維持する。

今後の拡張として、マウスボタンやスクロールでも切り替えを発火させるオプション、3枚以上の仮想デスクトップへの対応、ウィンドウ単位の移動などが考えられる。